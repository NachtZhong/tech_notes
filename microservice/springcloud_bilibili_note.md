# SpringCloud B站教程学习笔记



### Eureka原理

Eureka实质上保存了一个微服务名称和实际RPC调用地址的key-value结构, 服务注册的时候会将本身的地址也注册到Eureka中, 消费者在注册到Eureka之后会将所有的服务地址缓存到本地, 并且定时更新, 底层实际上还是利用HttpClient来进行服务间的调用, 默认30s更新一次服务地址

### Eureka自我保护机制

**现象**: 默认情况下，当eureka server在一定时间内没有收到实例的心跳，便会把该实例从注册表中删除（默认是90秒），但是，如果短时间内丢失大量的实例心跳，便会触发eureka server的自我保护机制,此时某一个微服务不可用, Eureka不会马上清理, 依然会对该微服务的信息进行保存. 

**目的**: 该保护机制的目的是避免网络连接故障，在发生网络故障时，微服务和注册中心之间无法正常通信，但服务本身是健康的，不应该注销该服务，如果eureka因网络故障而把微服务误删了，那即使网络恢复了，该微服务也不会重新注册到eureka server了，因为只有在微服务启动的时候才会发起注册请求，后面只会发送心跳和服务列表请求，这样的话，该实例虽然是运行着，但永远不会被其它服务所感知

**进入保护模式的条件:** 如果Eureka Server最近1分钟收到renew的次数小于阈值（即预期的最小值，默认为0.85），则会触发自我保护模式，此时Eureka Server此时会认为这是网络问题，它不会注销任何过期的实例，即使该实例确实是人为停掉的。

**退出保护模式的条件:**最近收到renew的次数大于阈值后，则Eureka Server退出自我保护模式。

**在配置文件关闭自我保护模式: **在eureka server配置文件中加上如下配置即可：```eureka.server.enable-self-preservation=false```

